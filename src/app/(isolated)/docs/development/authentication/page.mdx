# Authentication

This guide provides step-by-step instructions for adding authentication to your application using **NextAuth.js**.

---

## 1. Install Authentication Dependencies

To begin, install the required packages for setting up authentication with **NextAuth.js**:

```bash
npm install next-auth @auth/prisma-adapter @prisma/client prisma
```

---

## 2. Configure Environment Variables

Add the following environment variables to your `.env` file. For sample values, refer to the **full-kit**:

```env
API_URL=your_api_url
NEXTAUTH_URL=your_nextauth_url
NEXTAUTH_SECRET=your_nextauth_secret
HOME_PATHNAME=your_home_pathname
```

---

## 3. Add Required Files

Next, copy the necessary files and directories from the **full-kit**:

- **Prisma Schema**: `prisma/schema.prisma`
- **API Route for NextAuth.js**: `src/app/api/auth/[...nextauth]/route.ts`
- **Authentication Layout and Pages**: `src/app/(plain-layout)/(auth)`
  - If you don't wish to use internationalization (i18n), make sure to remove its dependencies.
- **Authentication UI Pages**: `src/components/auth`
  - If i18n is not needed, remove the i18n-related dependencies.
- **Authentication Routes Configuration**: `src/configs/auth-routes.ts`
- **NextAuth Configuration**: `src/configs/next-auth.ts`
- **Prisma Client**: `src/lib/prisma.ts`
- **Authentication Utilities**: `src/lib/auth.ts`
- **Authentication Routes Utilities**: `src/lib/auth-routes.ts`
- **NextAuth Provider**: `src/providers/next-auth-provider.tsx`
- **Middleware**: `src/middleware.js`
  - If you do not need i18n, refer to the "Removing i18n Logic" section below for further steps.

---

## 4. Removing i18n Logic (Optional)

If you choose **not** to use internationalization (i18n) in your project, follow the steps below to modify `src/middleware.js`:

### 4.1. Remove I18n Imports

Delete any imports related to i18n:

- `Negotiator`, `match`, `i18n`
- Localization helper functions such as `isPathnameMissingLocale`, `ensureLocalizedPathname`

### 4.2. Remove `getLocale` Function

Remove the `getLocale` function entirely, as it is used to determine the locale, which is unnecessary without i18n.

### 4.3. Remove Locale Handling Logic

Delete any logic related to locale handling, including checks or redirects based on the locale.

---

### 4.4. Simplify the `redirectTo` Function

Update the `redirectTo` function to focus solely on redirecting to the given pathname, without handling locale:

```js
function redirectTo(pathname: string, request: NextRequest) {
  const redirectUrl = new URL(pathname, request.url).toString();
  return NextResponse.redirect(redirectUrl);
}
```

### 4.5. Simplify the `getFirstSegment` Function

Update `getFirstSegment` to return the first segment of the URL path without checking for a locale:

```js
function getFirstSegment(pathname: string) {
  return pathname.split("/").filter(Boolean)[0] || "";
}
```

---

## 5. Update the `Providers` Component

Ensure the `NextAuth` provider is included in your project by updating the `src/providers/index.tsx` file. Don't forget to add the `session` prop. Refer to the **full-kit** for an example implementation.

---

## 6. Update `package.json` Scripts

Add the following scripts to the `scripts` section of your `package.json`:

```json
"scripts": {
    ...
    "migrate": "npx prisma migrate dev",
    "postinstall": "prisma generate"
}
```

---

## 7. Set Up Prisma

Run the following command to generate the Prisma client:

```bash
npx prisma generate
```

---

## 8. Protecting Routes

To protect specific routes using authentication in your Next.js application, you can use Next.js middleware to check if a user is authenticated before allowing access. If the user is not authenticated, they will be redirected to the sign-in page. This functionality is implemented in the `src/middleware.ts` file.

- If a user tries to access a protected route without being authenticated, the middleware redirects them to the `/sign-in` page.
- If a user is authenticated but tries to access guest routes (routes that do not require authentication), they will be redirected to the home page or another specified route.

### Customize Route Protection

You can customize the route protection logic by defining which routes are considered guest routes, public routes, or the home page. These configurations are found in the `guestRoutes`, `publicRoutes`, and `homeRoute` variables within the `src/configs/routes.ts` file.

The middleware will then check the current `pathname` against these route configurations and determine whether to redirect or allow access based on the user's authentication status.

---

## 9. Additional Resources

For further information on setting up and using **NextAuth.js**, refer to the official documentation:

[NextAuth.js Documentation](https://next-auth.js.org/)

Additionally, for details on how to use and customize middleware in your Next.js application, refer to the official **Next.js Middleware documentation**:

[Next.js Middleware Documentation](https://nextjs.org/docs/app/building-your-application/routing/middleware)
